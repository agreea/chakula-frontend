<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Chakula - Better than Restaurants</title>

    <!-- Bootstrap Core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="css/core.css" rel="stylesheet">
    <link href="css/create_meal.css" rel="stylesheet">
    <link href="css/jquery.datetimepicker.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='https://fonts.googleapis.com/css?family=Muli:400,400italic' rel='stylesheet' type='text/css'>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>
    <script src="js/jquery.js"></script>
    <script src="js/js-cookie.js"></script>
    <script src="js/api_call.js"></script>
    <script src="js/create_host.js"></script>
    <script src="js/host_fb_login.js"></script>
    <script src="js/create_meal.js"></script>
    <script src="js/moment.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="js/bootstrap.min.js"></script>
    <script src="js/jquery.datetimepicker.full.min.js"></script>
    <script>
      var formData = new FormData();
      var price = 0;
      var seats = 2;
      var title = '';
      var description = '';
      var starts = 0;
      var rsvpBy = 0;
    </script>
    <script type="text/babel">
// Documentation for the datepicker: http://xdsoft.net/jqplugins/datetimepicker/

var pics = [];

Date.parseDate = function(input, format){
  return moment(input,format).toDate();
};

Date.prototype.dateFormat = function(format){
  return moment(this).format(format);
};

var PriceSeatsRow = React.createClass({
  getInitialState: function() {
    total_payout = this.props.price * this.props.current_seats;
    return {price: this.props.price, current_seats: this.props.current_seats, total_payout: total_payout};
  },
  priceChanged: function(event) {
    price = event.target.value;
    console.log(price);
    // render();
    this.setState({price: price, total_payout: this.state.seats * price});
  },
  seatsChanged: function(seat_count) {
    seats = seat_count;
    console.log(seats);
    this.setState({current_seats: seats, total_payout: this.state.price * seats});
  },
  // seatsChanged: function(event) {
  //   seats = 
  // },
  render: function() {
    return (
        <div className="row">
          <div className="col-sm-6">
            <h4>Price per plate</h4>
            <div className="input-group">
              <span className="input-group-addon">$</span>
              <input className="form-control" id="price" type="text" defaultValue={this.state.price} onChange={this.priceChanged} placeholder="Price per plate (guests will pay 28% more)"/>
            </div>
            <p id="guests-pay">{"Guests will pay: $" + this.state.price * 1.28}</p>
           </div> 
          <div className="col-sm-4">
            <h4>Guest Seats</h4>
            <div className="dropdown">
              <button className="btn btn-default dropdown-toggle" id="seats" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                {this.state.current_seats}
                <span class="caret"></span>
              </button>
              <ul className="dropdown-menu" aria-labelledby="dropdownMenu1">
                { this.props.possible_seats.map(function(seat_count, i) {
                    return (
                      <li><a className='seat' onClick={this.seatsChanged.bind(this, seat_count)} key={i}>{seat_count}</a></li>
                    );
                  }, this)}
              </ul>
            </div>
          </div>
          <div className="col-sm-2">
            <h4>Max Pay</h4>
            <p id="payout-val">{this.state.total_payout}</p>
          </div>
        </div>
  );
 }
});

var Pic = React.createClass({
  render: function() {
    return (
        <img className="img-responsive pic" src={this.props.pic_url}/>
    );
  }
});

var Caption = React.createClass({
  handleChange: function(event) {
    this.setState({value: event.target.value});
    var index = this.props.i;
    pics[index].caption = event.target.value;
  },
  render: function() {
    return (
      <input className="form-control" type="text" placeholder="Caption?" onChange={this.handleChange} i={this.props.i}/>
    );
  }
});

var PicList = React.createClass({
  render: function() {
    var index = 0;
    var picNodes = this.props.data.map(function (pic) {
      console.log("Here is the index at PicList's render:" + index);
      var picNode = (<div className="col-sm-4 pic-card text-center">
                        <Pic pic_url={pic.Name}></Pic>
                        <Caption defaultValue={pic.Caption} i={index}/>
                      </div>);
      index++;
      return (picNode);
    });
    return (
      <div className="picList row">
        {picNodes}
      </div>
    );
  }
});

function render() {
    React.render(
      <PicList data={pics} />,
      document.getElementById('pic-grid'));
    React.render(
      <PriceSeatsRow price={price} current_seats={seats} possible_seats={[2,3,4,5,6,7,8,9,10,11,12]} />,
      document.getElementById('price-plates-row'));
}
function readURL(input) {
      var files = input.files;
      for (var i in files) {
        var file = files[i]
        if (!file.type.match('image.*')) {
          continue;
        }
        var reader = new FileReader();
        reader.onload = function (e) {
          pics.push({Name: e.target.result, Caption: ""});
          render();
        }
        reader.readAsDataURL(file);
      }
}

function setListeners() {
  $('#price').change(function(){
    price = $(this).val();
    console.log(price);
    $('#payout-val').text('$' + price * seats);
    $('#guests-pay').text('Guests will pay: $' + price * 1.28);
  });
  $("#img-upload").change(function(){
    readURL(this);
  });
  $('#save').click(function(){
    var data = {
        method: 'saveMealDraft',
        title: title,
        description: description,
        starts: starts,
        rsvpBy: rsvpBy,
        price: price,
        seats: seats,
        pics: JSON.stringify(pics),
        session: Cookies.get('session'),
      };
    var api_resp = api_call('meal', data);
    console.log(data);
    console.log(api_resp);
    if (api_resp.Success) {
      // SHOW error!!!
      $('#error-field').hide();
    } else {
      $('#error-field').html('<li>' + api_resp.Error + '</li>');
    }
        // console.log('starts: ' + starts);
        // console.log('rsvpBy: ' + rsvpBy);
        // console.log('seats: ' + seats);
        // console.log('price: ' + price);
        // console.log('title: ' + title);
        // console.log('description: ' + description);
        // console.log('pics: ' + pics);
      }
);
  $('#title').change(function(){
    title = $(this).val();
  });
  $('#description').change(function(){
    description = $(this).val();  
  });
}

function initDatepickers() {
  $('#rsvp-by-time').datetimepicker({
    format:'MM.DD.YYYY h:mm a',
    formatTime:'h:mm a',
    formatDate:'DD.MM.YYYY',
    inline:false,
    lang:'en',
    onChangeDateTime:function(dp,$input){
      var date_time = Date.parseDate($input.val(), 'MM.DD.YYYY h:mm a');
      starts = date_time.getTime()/100000;
      console.log(starts);
    }
  });
  $('#starts-time').datetimepicker({
    format:'MM.DD.YYYY h:mm a',
    formatTime:'h:mm a',
    formatDate:'DD.MM.YYYY',
    inline:false,
    lang:'en',
    onChangeDateTime:function(dp,$input){
      var date_time = Date.parseDate($input.val(), 'MM.DD.YYYY h:mm a');
      rsvpBy = date_time.getTime()/100000;
      console.log(rsvpBy);
    }
  });
}

 $(document).ready(function(){
  $('#nav').load('include/nav_bar.html');
  $('#guests-pay').text('Guests will pay: $' + price * 1.28);
  $('#payout-val').text('$' + price * seats);
  initDatepickers();
  setListeners();
  render();
  var session = Cookies.get('session');
    if (session === undefined || session === "") {
      // $('.meal-data').hide();
    } else {
      $('#fb').hide();
      // api_resp = getHostData();
      // if (api_resp.Success) {
      //   console.log("success");
      //   // // populate the host data fields
      //   // setupHostData(api_resp.Return);
      // } else {
      //   console.log("failure");
      //   // show an error message or fb login
      // }
    }
  });
    </script>
    <script type="text/javascript">
      urlVars = getUrlVars();
    </script>
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <script>
      // (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      // (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      // m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      // })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      // ga('create', 'UA-66943306-1', 'auto');
      // ga('send', 'pageview');
    </script>
</head>

<body id="page-top" data-spy="scroll" data-target=".navbar-fixed-top">
<!--
  Below we include the Login Button social plugin. This button uses
  the JavaScript SDK to present a graphical Login button that triggers
  the FB.login() function when clicked.
-->
<div class="row">
  <div id="nav">
  </div>
  <div id="fb">
    <h3 class="text-center">First, Login With Facebook</h3>
    <div class="row text-center">
      <fb:login-button class="fb-login" scope="public_profile,email" onlogin="checkLoginState();">
      </fb:login-button>
    </div>
  </div>
  <div class="meal-data">
          <h2 class="text-center">Your Meal</h2>
    <div class="col-md-8 col-md-offset-2">
        <input class="form-control meal-title" id="title" type="text" placeholder="Give your meal a snazzy title."/>
        <textarea class="form-control" id="description" type="text" rows="8" placeholder="Describe your meal. What's in it? What inspired you to make it?"></textarea>
        <div id="price-plates-row">
      </div>
      <div class="row">
        <div class="col-sm-6">
          <h4>Meal Start Time</h4>
          <input class="form-control" id="starts-time" type="text" size="20" placeholder="Start time?"/>
        </div>
        <div class="col-sm-6">
          <h4>RSVP By Time</h4>
          <input class="form-control" id="rsvp-by-time" type="text" size="40" placeholder="Rsvp by?"/>
        </div>
      </div>
      <div class="upload-img-form">
        <div class="fileUpload btn btn-primary">
          <span>Upload</span>
          <input class="upload" id="img-upload" type="file" multiple/>
        </div>
      </div>
      <div class="photos">
        <div class="pic-grid" id="pic-grid">
        </div>
      </div>
      <ul class="error-field" id="error-field">
      </ul>
      <button class="brand-btn btn-info btn-lg btn" id="save" type="button">Save</button>
      <button class="brand-btn btn-info btn-lg btn" id="publish" type="button">Publish</button>
    </div>
  </div> 
    <!-- Footer -->
    <!-- Plugin JavaScript -->
    <script src="js/jquery.easing.min.js"></script>
</div>
      <footer>
        <div class="container text-center">
            <p>Copyright &copy; Chakula 2015</p>
        </div>
    </footer>

</body>
</html>
