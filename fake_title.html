<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Example of Bootstrap 3 Affix</title>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <!-- Custom CSS -->
    <link href="css/core.css" rel="stylesheet">
    <link href="css/meal.css" rel="stylesheet">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

    <!-- Custom Fonts -->
    <link href="font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='https://fonts.googleapis.com/css?family=Muli:400,400italic' rel='stylesheet' type='text/css'>
    <link href="https://fonts.googleapis.com/css?family=Lato:400,300,700" rel="stylesheet" type="text/css">
    <script src="https://fbcdn-dragon-a.akamaihd.net/hphotos-ak-xat1/t39.3284-6/12056998_1697020110531721_1758939694_n.js"></script>
    <script src="js/api_call.js"></script>
    <script src="js/js-cookie.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>
    <script type="text/babel" src="js/checkout_browserify_v2.js"></script>
<!-- 
    <script src="js/jquery.js"></script>
    <script src="js/js-cookie.js"></script>
    <script src="js/api_call.js"></script>
    <script src="js/moment.js"></script>
    <script type="text/babel" src="js/nav_bar.js"></script> 
-->
    <script type="text/javascript" src="https://js.stripe.com/v2/"></script>
    <!-- <script type="text/babel" src="js/nav_bar.js"></script> -->
    <!-- <script type="text/babel" src="js/nav_bar.js"></script> -->
    <!-- <script type="text/babel" src="js/nav_bar.js"></script> -->
    <!-- <script type="text/babel" src="js/nav_bar.js"></script> -->
    <!-- <script type="text/babel" src="js/nav_bar.js"></script> -->
    <!-- <script type="text/babel" src="js/nav_bar.js"></script> -->
    <!-- <script type="text/babel" src="js/nav_bar.js"></script> -->
    <!-- <script type="text/babel" src="js/nav_bar.js"></script> -->
    <!-- <script type="text/babel" src="js/nav_bar.js"></script> -->

    <script type="text/babel">
var TextField = React.createClass({
    editClicked: function() {
        this.setState({input_stored: false});
        console.log("input stored??");
    },
    getInitialState: function() {
        return {input_stored: this.props.input_stored};
    },
    handleChange: function(event) {
        this.setState({value: event.target.value});
    },
    render: function() {
        var input;
        if(this.state.input_stored) {
            input = <p>
                {this.props.val} <a onClick={this.editClicked}>
                    <i className="fa fa-pencil"></i>
                </a></p>;
        } else {
            input = <input type="text" 
                id={this.props.id} 
                placeholder={this.props.placeholder} 
                defaultValue={this.props.val}
                onChange={this.handleChange}></input>;
        }
        return (
            <div className="row">
                <div className="col-xs-3 col-sm-2 col-lg-1 label-text text-right">
                    <p>{this.props.label}</p>
                </div>
                <div className="col-xs-8 col-sm-4">{input}</div>
            </div>);
    }
});

var PaymentField = React.createClass({
    handleAddCard: function() {
        $('#add-card-btn').prop('disabled', true);
        Stripe.card.createToken($('#cc-form'), this.stripeResponseHandler);
    },
    handleStripeResponse: function(status, stripe_resp) {
        if (stripe_resp.error) {
            // Show the errors on the form
            $('#add-card-btn').prop('disabled', false);
            this.setState({addCardError: stripe_resp.error})
            return;
        }
        // token contains id, last4, and card type
        this.handleStripeSuccess(stripe_resp);
    },
    handleStripeSuccess: function(stripe_resp) {
        var api_resp = 
            api_call("kitchenuser", {
                method: "AddStripe",
                session: Cookies.get("session"),
                stripeToken: stripe_resp.id,
                last4: stripe_resp.card.last4});
        if (!api_resp.Success) {
            $('#add-card-btn').prop('disabled', false);
            this.setState({addCardError: api_resp.Error});
            return;
        }
        this.props.cards.push(stripe_resp.card.last4);
        this.setState({showAddCardForm: false, selected: stripe_resp.card.last4});
    },
    handlePaymentPress: function() {
        this.setState({paymentPressed: true});
    },
    radioChanged: function(e) {
        this.setState({showAddCardForm: e.currentTarget.id === "add-card", selected: e.currentTarget.id, addCardError: ''});
    },
    cardsList: function () {
        var radioChanged = this.radioChanged;
        var selected_card = this.state.selected;
        var cards = this.props.cards.map(function(card, index) {
            return <p><input type="radio" 
                name="card" 
                onChange={radioChanged}
                checked={card == selected_card}
                id={card}>{" **** - **** - **** - " + card}</input></p>
        });
        var add_card; // add-card radio option. shows input form if it's selected
        if (this.state.showAddCardForm) {
            add_card = 
                <div>
                    <p>
                        <input className="row" 
                            type="radio" 
                            onChange={radioChanged} 
                            id="add-card"
                            checked={true}> Add Card</input>
                    </p>
                    {this.addCardForm()}
                </div>;
        } else {
            add_card = 
                <p>
                    <input type="radio" 
                        name="card" 
                        onChange={radioChanged} 
                        id="add-card"> Add Card</input>
                </p>;
        }
        cards.push(add_card);
        return <form className="col-xs-7 col-sm-5" id="cards">{cards}</form>;
    },
    addCardForm: function() {
        return (
            <div className="row">
                <form id="cc-form" className="col-sm-8">
                    <span className="error-field" id="payment-errors"></span>
                    <div className="form-row">
                      <label>
                         <input type="text" size="20" data-stripe="number" placeholder="Card #"/>
                      </label>
                    </div>
                    <div className="form-row">
                        <label>
                            <input type="text" size="4" data-stripe="exp-month" placeholder="MM"/>
                        </label>
                        <span> / </span>
                        <label>
                            <input type="text" size="4" data-stripe="exp-year" placeholder="YY"/>
                        </label>
                        <span>  </span>
                        <label>
                             <input type="text" size="4" data-stripe="cvc" placeholder="CVC"/>
                          </label>
                    </div>
                  <div className="text-center">
                      <button className="brand-btn btn btn-payment" id="add-card-btn" onclick={this.handleAddCard}>Add Card</button>
                  </div>
                </form>
            </div>);
    },
    getInitialState: function() {
        return(
            {addCard: false, 
            paymentPressed: false, 
            selected: this.props.cards[0]});
    },
    render: function() {
        var paymentField;
        if (!this.state.paymentPressed && this.props.cards.length > 0) {
            paymentField = 
                <div className="col-xs-5 col-sm-4 col-md-3">
                    <p><button className="payment-button"onClick={this.handlePaymentPress}><i className="fa fa-credit-card"></i> {this.props.cards[0]}</button></p>
                </div>;
        } else {
            paymentField = this.cardsList();
        }
        return(  
            <div className="row">
                <div className="col-xs-3 col-sm-2 col-lg-1 label-text text-right">
                    <p>Payment</p>
                </div>
                {paymentField}
            </div>);
    }
});

var CheckoutForm = React.createClass({
    handleBookPressed: function() {
        var cards = $('#cards');
        if (!cards){
            // process the booking with the auto selected card
            return;
        }
        var selected_card = $('input[name=card]:checked', '#cards').attr('id');
        console.log(selected_card)
        if (!selected_card || !/^\d{4}$/.test(selected_card)) { 
            // if no card is selected or selection is not a last4 digits:
            // show error
            this.setState({error: 'Select a valid card.'})
            console.log('Card was invalid: ' + selected_card);
            return;
        }
        console.log('card was valid');
        api_resp = api_call('meal', {method: 'checkout', session: Cookies.get('session'), last4: selected_card});
        if (api_resp.Success) {
            // idk close the modal? Show a success screen?
        } else {
            // show errors?
            this.setState({error: api_resp.Error});
        }
    },
    getInitialState: function() {
        return({error: ''});
    },
    render: function() {
        return(
            <div className="text-left row">
                <PaymentField cards={this.props.cards}></PaymentField>
                <div className="row error-field">
                    <p>{this.state.error}</p>
                </div>
                <div className="row">
                    <div className="col-xs-8 col-xs-offset-3 col-sm-6 col-sm-offset-2 col-md-5 col-lg-4 col-lg-offset-1">
                        <button className="brand-btn " 
                            disabled={this.props.cards.length === 0} 
                            onClick={this.handleBookPressed}>Book</button>
                    </div>
                </div>
            </div>);
    }
});
// check for session: if none ==> show facebook and return
// get checkout for meal id: {following, credit_cards, hasEmail, hasPhone}
/*
*/
function render(){
    var session = Cookies.get('session');
    if(!session) {
        // show facebook login

        return;
    }
    var api_resp = api_call('meal', {method: 'checkout', session: session});
    if (!api_resp.Success){
        // show error... ??? What causes this?
        return;
    }
    React.render(<CheckoutForm cards={[1234,2345,3456,4567]}/>, document.getElementById('checkout'));
}
    </script>
    <script src="js/fb_login.js"></script>
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-66943306-1', 'auto');
      ga('send', 'pageview');
    </script>
</head>
<body>
<div class="container">
	<div id="checkout">
    </div>
    <div id="login">
    </div>
</body>
</html>                                		