<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Chakula - Better than Restaurants</title>

    <!-- Bootstrap Core CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

    <!-- Custom CSS -->
    <link href="css/core.css" rel="stylesheet">
    <link href="css/meal.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='https://fonts.googleapis.com/css?family=Muli:400,400italic' rel='stylesheet' type='text/css'>
    <link href="https://fonts.googleapis.com/css?family=Lato:400,300,700" rel="stylesheet" type="text/css">
    <script src="js/jquery.js"></script>
    <script src="js/js-cookie.js"></script>
    <script src="js/api_call.js"></script>
    <script src="js/moment.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>
    <!-- <script type="text/babel" src="js/nav_bar.js"></script> -->
    <script type="text/javascript" src="https://js.stripe.com/v2/"></script>
    <script type="text/babel">
// var api_resp = getMeal();
// var meal_data;
// if (api_resp.Success) {
//   meal_data = api_resp.Return;
// } else {
//   window.location.replace("https://yaychakula.com");
// }
var json_str = '{  "Success": 1,  "Return": {    "Id": 4,    "Title": "Moldovan Mamaliga ca la Mamica Acasa",    "Description": "Hosting guests in Moldova is an art. That\'s why I wish to invite you to try a bite of a traditional Moldovan food that, I hope, will be as much an experience as it will be a meal. For appetizers we\'ll have some traditional vegetables and brinza. The main course will be mamailga with brinza and smintina  ca la Mamica acasa: a Eastern-European version of polenta with traditional cottage cheese, eggs and beef, as my mom prepares it. And for dessert, get ready for an unexpected combo of walnuts and prunes!",    "Host_name": "Felicia",    "Host_pic": "https://graph.facebook.com/1154984147851446/picture?width=200\u0026height=200",    "Host_bio": "Born and raised in Moldova, I came to the US as a Sophomore in high-school and for the past six years I\'ve come to call the US my second home. Yet I\'ll obviously never forget the customs and traditions of my own tiny country in Eastern-Europe. And it is exactly those customs and culture I\'d like to share with you--all in a delicious home cooked Moldova meal! ",    "Address": "Address revealed upon purchase",    "Open_spots": 0,    "Price": 12.28800048828125,    "Status": "NONE",    "Maps_url": "https://maps.googleapis.com/maps/api/staticmap?size=600x300\u0026scale=2\u0026zoom=14\u0026center=3806 T street NW Washington, DC",    "Has_email": false,    "Attendees": [      {        "First_name": "Agree",        "Prof_pic_url": "https://graph.facebook.com/10153547967605406/picture?width=200\u0026height=200",        "Seats": 1      },      {        "First_name": "Dylan",        "Prof_pic_url": "https://graph.facebook.com/851653691596622/picture?width=200\u0026height=200",        "Seats": 2      },      {        "First_name": "Suzanne",        "Prof_pic_url": "https://graph.facebook.com/10153191455001238/picture?width=200\u0026height=200",        "Seats": 1      },      {        "First_name": "Yanpei",        "Prof_pic_url": "https://graph.facebook.com/962315110496021/picture?width=200\u0026height=200",        "Seats": 1      },      {        "First_name": "Laura",        "Prof_pic_url": "https://graph.facebook.com/10207809944992502/picture?width=200\u0026height=200",        "Seats": 1      },      {        "First_name": "Danny",        "Prof_pic_url": "https://graph.facebook.com/10153281231090852/picture?width=200\u0026height=200",        "Seats": 1},      {        "First_name": "Patrick",        "Prof_pic_url": "https://graph.facebook.com/10204833378666675/picture?width=200\u0026height=200",        "Seats": 1      },      {        "First_name": "Emma",        "Prof_pic_url": "https://graph.facebook.com/10206231655904112/picture?width=200\u0026height=200",        "Seats": 1      },      {        "First_name": "Stephen",        "Prof_pic_url": "https://graph.facebook.com/10207590849346321/picture?width=200\u0026height=200",        "Seats": 1      },      {        "First_name": "Madeleine",        "Prof_pic_url": "https://graph.facebook.com/10153217449628105/picture?width=200\u0026height=200",        "Seats": 1      }    ],    "Starts": "2015-10-03T23:00:00Z",    "Rsvp_by": "2015-10-02T23:00:00Z",    "Pics": [      {        "Name": "m16.jpg",        "Caption": ""      },      {        "Name": "m15.jpg",        "Caption": "Chopped veggies and brinza (a Moldovan cheese)"      },      {        "Name": "m17.jpg",        "Caption": ""      },      {        "Name": "h3.jpg",        "Caption": "Me in traditional Moldovan garb, which I\'ll be wearing at the dinner!"      }    ],    "Meal_reviews": null,    "Host_reviews": [      {        "First_name": "Agree",        "Prof_pic_url": "https://graph.facebook.com/10153547967605406/picture?width=200\u0026height=200",        "Meal_id": 4,        "Meal_title": "Moldovan Mamaliga ca la Mamica Acasa",        "Rating": 5,        "Comment": "It\'s been a long long time since I had a meal with such a range of flavors as Felicia\'s. I honestly didn\'t know what to expect when I signed up for Moldovan food. But Felicia was one hell of a host. Besides making individual plates for 13(!) guests, each with multiple courses on them, she also had prepared lightly pickled herring on rye bread and platters of sliced cucumbers and tomatoes with this heavenly feta-like cheese. Before we broke bread, she gave everybody a crash course in Moldovan cuisine, complete with instructions on how to eat.",        "Date": "2015-10-06T03:59:12Z"      },      {        "First_name": "Patrick",        "Prof_pic_url": "https://graph.facebook.com/10204833378666675/picture?width=200\u0026height=200",        "Meal_id": 4,        "Meal_title": "Moldovan Mamaliga ca la Mamica Acasa",        "Rating": 5,        "Comment": "This meal was a unique dining experience. I learned a whole lot about Moldovan cuisine and culture!! Felicia was an engaged and accommodating host, and the food was very well prepared. Price was extremely reasonable. ",        "Date": "2015-10-06T15:39:38Z"      },      {        "First_name": "Suzanne",        "Prof_pic_url": "https://graph.facebook.com/10153191455001238/picture?width=200\u0026height=200",        "Meal_id": 4,        "Meal_title": "Moldovan Mamaliga ca la Mamica Acasa",        "Rating": 5,        "Comment": "Felicia\'s traditional Moldovan dinner was a delicious, awesome experience! She is such a good cook and a friendly person!",        "Date": "2015-10-06T20:05:21Z"      },      {        "First_name": "Joe",        "Prof_pic_url": "https://graph.facebook.com/10153630183039664/picture?width=200\u0026height=200",        "Meal_id": 28,        "Meal_title": "Moldovan Mamaliga ca la Mamica Acasa",        "Rating": 5,        "Comment": "Delish!",        "Date": "2015-10-25T07:09:25Z"      }    ]  },  "Error": ""}';
console.log("about to parse JSON text");
var meal_data = JSON.parse(json_str).Return;
var Carousel = React.createClass({
  render: function() {
    var pictures = this.props.data.map(function(pic, index) {
      if (index == 0) {
        return (<div className="item active">
          <img src={"img/" + pic.Name}></img>
          <div className="carousel-caption">{pic.Caption}</div>
        </div>);
      }
      return (<div className="item">
        <img src={"img/" + pic.Name}></img>
        <div className="carousel-caption">{pic.Caption}</div>
      </div>);
    });
    return (
      <div id="carousel-example-generic" className="carousel slide text-center" data-ride="carousel" data-interval="false">
        <div className="carousel-inner" id="carousel-pics" role="listbox">
          {pictures}
        </div>
        <a className="left carousel-control" href="#carousel-example-generic" role="button" data-slide="prev">
          <span className="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
          <span className="sr-only">Previous</span>
        </a>
        <a className="right carousel-control" href="#carousel-example-generic" role="button" data-slide="next">
          <span className="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
          <span className="sr-only">Next</span>
        </a>
      </div>
    );
  }
});

var ReviewBox = React.createClass({
  render: function() {
    return (
      <div className="reviewBox">
        <h3 className="text-left">Reviews</h3>
        <ReviewList data={this.props.data} />
      </div>
    );
  }
});

var Review = React.createClass({
  render: function() {
    var stars = [];
    for (var i = 0; i < this.props.rating; i++) {
      stars.push(<i className="fa fa-star"></i>);
    }
    return (
      <div className="review row">
        <div className="col-sm-2 text-center">
            <img className="img-circle guest-pic img-responsive" src={this.props.pic_url}/>
            <p className="reviewer-name">
              {this.props.first_name}
            </p>
        </div>
        <div className="col-sm-10 review-text">
          <p className="star-rating">
            {stars}
          </p>
          <p>{this.props.children}</p>
          <div className="row">
            <div className="col-sm-8 review-meal-title">
              <p><a href={"https://yaychakula.com/meal.html?Id=" + this.props.meal_id}>
                {this.props.title}
              </a></p>
            </div>
            <div className="col-sm-4">
              <p>
                {this.props.date}
              </p>
            </div>
          </div>
          <hr className="hr-review"/>
        </div>
      </div>
    );
  }
});

var ReviewList = React.createClass({
  render: function() {
    if (!this.props.data){
      return (
        <div className="reviewList">
          <p>No reviews yet!</p>
        </div>
      );
    }
    var reviewNodes = this.props.data.map(function (review) {
      return (
        <Review first_name={review.First_name} 
                date={moment(review.Date).format("MMM Do YYYY")} 
                pic_url={review.Prof_pic_url}
                rating={review.Rating}
                title={review.Meal_title}
                meal_id={review.Meal_id}>
          {review.Comment}
        </Review>
      );
    });
    return (
      <div className="reviewList">
        {reviewNodes}
      </div>
    );
  }
});

var HostAttendeesInfo = React.createClass({
  render: function() {
    // check meal type
    // if takeout, only show host
    // else show attendees too
    var data = this.props.data;
    console.log("HostAttendeesInfo data: ");
    console.log(data);
    return (<div className="row host-attendees-col">
      <div className="col-xs-12 col-sm-3">
        <img className="img-responsive img-responsive-center img-circle" src={data.Host_pic}/>
      </div>
      <div className="col-xs-12 col-sm-9">
        <h3>{"About " + data.Host_name}</h3>
        <p>{data.Host_bio}</p>
      </div>
    </div>);
  }
});

var BookMeal = React.createClass({
  render: function() {
    var data = this.props.data;
    var req_btn_disabled = 
      (moment(data.Rsvp_by) < moment()) || 
      data.Status == "ATTENDING" || 
      data.Status == "DECLINED" || 
      data.Status == "PENDING";
    var starts = moment(data.Starts);
    var req_btn_text;
    if (moment(meal_data.Rsvp_by < moment())) {
      req_btn_text = 'Meal closed';
    } else {
      req_btn_text = "Book";
    }
    var order_btn = 
      <button className="brand-btn btn" id="request-meal-btn" 
        disabled={req_btn_disabled}>{req_btn_text}</button>;
    var time_left_text;
    var booking_info = 
      [<p><i className="fa fa-clock-o"></i>{" " + starts.format("h:mm a ddd, MMM Do")}</p>,
        <p><span className="glyphicon glyphicon-ban-circle" aria-hidden="true"></span> Event is closed</p>];
    if (moment(data.Rsvp_by) > moment()) {
      booking_info.push(<p>{closes.toNow() + " left to book"}</p>);
    }
    return(
      <div className="col-xs-12 col-sm-3">
        <div className="book-meal">
          <div className="price-row"><h2>{"$" + Math.round(this.props.data.Price*100)/100}</h2><p>/person</p></div>
          {order_btn}
          {booking_info}
        </div>
      </div>
    );
  }
});

var MealInfo = React.createClass({
  render: function() {
    // todo: truncate descriptions
    moment().format("dddd, MMMM Do YYYY, h:mm:ss a"); // "Sunday, February 14th 2010, 3:25:50 pm"
    // $('#time-left-subtext').text('Requests are now closed.');
    // $('#time-left-subtext').css("color", "#aaa"); // set text to grey
    var data = this.props.data;
    var closes = moment(data.Rsvp_by);
    var map_row;
    if (data.Status != "ATTENDING") {
        map_row = 
          <div className="row map-row" style={{backgroundImage: 'url("' + data.Maps_url + '")'}}>
            <svg className="map-radius" height="100" width="100">
              <circle cx="50" cy="50" r="40" stroke="#3C8BA6" stroke-width="2" fill="#6DCDED" opacity=".8" />
            </svg>   
          </div>;
    } else {
      map_row = 
        <div className="row map-row">
          <a href={'https://www.google.com/maps/place/' + data.Address + ' Washington, DC'} target="_blank">
            <img className="map-img" src={data.Maps_url} />
          </a>
        </div>;
    }
    var avg_stars = [];
    if (data.Host_reviews !== null) { // process avg rating
      var ratings = data.Host_reviews.map(function(review) {
        return review.Rating;
      })
      var sum_ratings = ratings.reduce(function(previous, current) {
        return previous + current;
      });
      console.log("Sum ratings: " + sum_ratings);
      var avg_rating = (sum_ratings/data.Host_reviews.length);
      console.log("Average rating: " + avg_rating);
      while(avg_rating > 0) { // show the average rating in filled stars
        if (avg_rating < 1) { // for any remainder, round up to the next half-star and exit the loop
          if (avg_rating > .7) {
            avg_stars.push(<i className="fa fa-star"></i>);
          } else if (avg_rating > .3) {
            avg_stars.push(<i className="fa fa-star-half-o"></i>);
          }
          break;
        }
        avg_stars.push(<i className="fa fa-star"></i>);
        avg_rating--;
      }
      while(avg_stars.length < 5) { // for the remaining stars until five, show empty stars.
        avg_stars.push(<i className="fa fa-star-o"></i>);
      }
    }

    // handle newlines in the meal description
    var desc_lines = data.Description.split(/[\n\r]/g);
    var description = desc_lines.map(function(desc_line) {
      return <p>{desc_line}</p>;
    });

    return (
      <div className="col-xs-10 col-xs-offset-1 col-sm-8 col-sm-offset-0">
          <div className="row">
            <h2>{data.Title}</h2>
            <p className="star-rating">{avg_stars}</p>
          </div>
          <div className="row">
            {description}
          </div>
          <HostAttendeesInfo data={this.props.data}/>
          <div className="row">
            <p><i className="fa fa-map-marker"></i>{" " + data.Address}</p>
          </div>
          {map_row}
          <div className="row">
            <ReviewBox data={data.Host_reviews} />
          </div>
      </div>
    );
  }
});

var Meal = React.createClass({
  render: function() {
    return(
      <div className="row">
        <div className="row text-center">
          <div className="col-xs-12 col-sm-9 col-sm-offset-2">
            <Carousel data={this.props.data.Pics}></Carousel>
          </div>
        </div>
        <div className="row">
          <BookMeal data={this.props.data}></BookMeal>
          <MealInfo data={this.props.data}></MealInfo>
        </div>
    </div>);
  }
});

React.render(
  <Meal data={meal_data}/>,
  document.getElementById('meal')
);
console.log("React render just got passed");
function getMeal(){
  urlVars = getUrlVars();
  api_resp = api_call("meal", {
                      method: "getMeal",
                      session: Cookies.get("session"),
                      mealId: urlVars["Id"],
                    });
  console.log(api_resp);
  return api_resp;
}

function getCards() {
  api_resp = api_call("kitchenuser", {
                      method: "getLast4s",
                      session: Cookies.get("session")
                    });
  if (api_resp.Success) {
    Cookies.set('cards', api_resp.Return)
  }
}
    </script>
    <!-- Bootstrap Core JavaScript -->
    <script>
      urlVars = getUrlVars();
      // on page load, check if you have a cookie for the request
      // if you do, check with the server if you are attending or not attending this meal
           $(document).ready(function(){
                id = urlVars["Id"];
                if(Cookies.get("session") === undefined) {
                  console.log("No session");
                  $('#signin-dropdown').html('<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Sign in</a>');
                } else if(!meal_data.Has_email) {
                  $('#modal-body').load('include/add_email.html');
                } else if(Cookies.getJSON("cards") === undefined || 
                          Cookies.getJSON("cards").length === 0 || 
                          Cookies.getJSON("cards")[0] === null) {
                  getCards();
                  if(Cookies.getJSON("cards") === undefined ||
                      Cookies.getJSON("cards").length === 0 || 
                      Cookies.getJSON("cards")[0] === null) {
                    console.log("No card");
                    $('#modal-body').load('include/stripe_form.html');
                  }
                } else if(Cookies.getJSON("requests") === undefined || Cookies.getJSON("requests")[id] === undefined) {
                  $('#modal-body').load('include/request_invoice.html');
                }
                if(Cookies.get("session") != undefined) {
                  console.log("there was a session");
                  // todo: show name and signout in navbar
                }
           });
    </script>
    <script src="js/fb_login.js"></script>
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-66943306-1', 'auto');
      ga('send', 'pageview');
    </script>
</head>

<body id="page-top">
<div id="nav-bar">
</div>
<div class="container-fluid" id="meal">
</div>
<!-- Modal -->
<div id="request-modal" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" id="request-meal-btn">&times;</button>
        <h4 class="modal-title text-center">Request Meal</h4>
      </div>
      <div class="modal-body row" id="modal-body">
        <div class="row">
          <h3 class="text-center">First, Login With Facebook</h3>
          <div class="row text-center">
              <fb:login-button class="fb-login" scope="public_profile,email" onlogin="checkLoginState();">
                </fb:login-button>
          </div>
<!--           <img class="fb-login img-responsive" src="img/fb-login.svg" onclick="FB.login()">
 -->      <div class="col-sm-8 col-sm-offset-2">
            <div class="checkbox">
                <label><input type="checkbox" id="subscribe-check" checked>I want to receive weekly emails of upcoming meals on campus.</label>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  function fixDiv() {
    console.log("FixDiv!")
      var $book_meal = $('.book-meal');
      var width = $book_meal.parent().width();
      console.log("Window's inner width: " + window.innerWidth);
      if ($(window).scrollTop() > 500 && window.innerWidth > 767) {
          $book_meal.css({
            'position': 'fixed',
            'top': '10px',
            'width': width
          });
      } else {
        $book_meal.css({
          'position': 'relative',
          'top': 'auto',
          'width': width
        });
      }
  }
  console.log("Fix div getting attached");
  console.log(window.innerWidth);
  $(window).scroll(fixDiv);
</script>
<!-- Footer -->
    <footer>
    </footer>
</body>

</html>
